<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <script>
        const contractAddress_game = "0x3A1B0389eb69BC362257348F2449Df3536044a60";
        const contractAddress = "0xCC8456f29C95882b9Ad5d1Bd7D8E1174793c668D";
        let web3
        let contract
        let contract_game

        async function enable() {
            if (window.ethereum) {
                ethereum.request({ method: 'eth_requestAccounts' }).then(function (res) {
                    account = res[0]
                    console.log('Connected Account: ' + account);
                    web3 = new Web3(window.ethereum);
                    document.getElementById("metamask").innerHTML = "Metamask is enabled!\n Connected Account: " + account;
                    
                    let abi = getAbi();
                    
                    
                    
                    
                    contract = new web3.eth.Contract(abi, contractAddress);
                    console.log(contract)
                    //contract_game = new web3.eth.Contract(abi_game, contractAddress_game)
                    console.log(contract_game)

                    // contract objekt erstellen
                    // let abi = getAbi(); // die Funktion gibt die ABI zur√ºck
                    //contract = new web3.eth.Contract(abi, contractAddress);

                })

            }
        }

        async function getBalanceETH() {

            let balanceWei = await web3.eth.getBalance(account);
            let balance = web3.utils.fromWei(balanceWei, 'ether');
            document.getElementById("balanceEth").innerHTML = "Balance ETH: " + balance + " ETH";

        }

    

        async function sendTransaction() {
            
            // contract aufrufen
            // siehe: https://web3js.readthedocs.io/en/v1.2.11/web3-eth-contract.html
            // let tx = await contract.methods.METHOD_NAME(PARAMETER).send({ from: account, value:contract_st VALUE });

        }


        function getAbi_Game() {  [
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "WinnerAddress",
          "type": "address"
        }
      ],
      "name": "GameEnded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "GameStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "playerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "bytes32",
          "name": "commitment",
          "type": "bytes32"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "PlayerCommitted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "playerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "PlayerRefundClaimed",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "playerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "PlayerRemoved",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "playerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "number",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "PlayerRevealed",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "RevealPhaseStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "winner",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "rewardAmount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "RewardRecorded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "contractOwner",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "feeAmount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "ServiceFeeRecorded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "recipient",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "Withdrawal",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "closestPlayers",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "_hash",
          "type": "bytes32"
        }
      ],
      "name": "commitHash",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "contractOwner",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "countdown",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "determineWinner",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "entryFee",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "gameEnded",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "gameFees",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "totalEntryFees",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "serviceFee",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "winnerReward",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "gameStarted",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "hasPaidEntryFee",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "initialize",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "leaveGame",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "maxNumberOfPlayers",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "minNumberOfPlayers",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "numberJoinedPlayers",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "pendingWithdrawals",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "playerCommitments",
      "outputs": [
        {
          "internalType": "bytes32",
          "name": "",
          "type": "bytes32"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "playerHasRevealed",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "playersWhoHaveRevealed",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_number",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_salt",
          "type": "string"
        }
      ],
      "name": "revealNumber",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "revealPhase",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "revealPhaseStartTime",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "startRevealPhase",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "withdraw",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]
  }
        function getAbi() {
            // return ABI
            return [
     {
      "inputs": [
        {
          "internalType": "address",
          "name": "_template",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "gameAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "creator",
          "type": "address"
        }
      ],
      "name": "GameCreated",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "createGame",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "games",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getGames",
      "outputs": [
        {
          "internalType": "address[]",
          "name": "",
          "type": "address[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "template",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
}
        
let createGamePromise;
async function createGame() {
  try {
    createGamePromise = contract.methods.createGame().send({ from: account });
    console.log("Creating game...");
  } catch (error) {
    console.error(error);
  }
}
async function getGameAddress() {
  try {
    if (!createGamePromise) {
      console.error("Game not created yet.");
      return;
    }
    let receipt = await createGamePromise;
    if (receipt.events.GameCreated) {
      let gameAddress = receipt.events.GameCreated.returnValues.gameAddress;
      document.getElementById("gamecreated").innerHTML = "Game Address: " + gameAddress;
      var gameAddressElement = document.getElementById('gameAddress');
      gameAddressElement.textContent = "Game address: " + gameAddress;
    } else {
      console.log("GameCreated event not triggered");
    }
  } catch (error) {
    console.error(error);
  }
}
//     if (tx.events && tx.events.GameCreated) {
//       let gameAddress = tx.events.GameCreated.returnValues.gameAddress;
//       document.getElementById("gamecreated").innerHTML = "Game Address: " + gameAddress;
//       // Get the gameAddress element
//       var gameAddressElement = document.getElementById('gameAddress');
//       // Update the content with the game address
//       gameAddressElement.textContent = "Game address: " + gameAddress;
//     } else {
//       console.log("GameCreated event not triggered");
//     }
//   } catch (error) {
//     console.error(error);
//   }
// }


        
        async function getGames() {
            let tx = await contract.methods.getGames().send({ from: account });
            console.log("join game")
            document.getElementById("getGames").innerHTML = tx;
            
        }

    </script>
</head>

<body>
    <h1>2/3 Blockchain3Game</h1>
    <h2>Connect Metamask</h2>
    <button class="button" type="button" onclick="enable()">Enable MetaMask</button>
    <p id="metamask"></p>
  
    

    <h2>Check Balance</h2>
    <button class="button" type="button" onclick="getBalanceETH()">Get ETH Balance</button>
    <p id="balanceEth">Balance ETH: </p>
    <hr>
    <h2>Gamemaster</h2>
    <button class="button" type="button" onclick="createGame()">Create Game</button>
    <p id="gameAddress">Game Address active: </p>
    <p id="gamecreated">Game Address: </p>
    <hr>
    <h2>Spieler 1</h2>
    <button class="button" type="button" onclick="joinGame()">Join Game</button>
    <input type="text" id="NUMBERID" placeholder="Number">
    <button class="button" type="button" onclick="submitNumber()">Submit Number</button>
    <input type="text" id="SALTID" placeholder="Salt">
    <button class="button" type="button" onclick="submitSalt()">Submit Salt</button>
    <br>
    <button type="button" id="ABMELDENID"> Austreten </button>
    <hr>
    <h2>Spieler 2</h2>
    <button class="button" type="button" onclick="joinGame()">Join Game</button>
    <input type="text" id="NUMBERID" placeholder="Number">
    <button class="button" type="button" onclick="submitNumber()">SubmitNumber</button>
    <input type="text" id="SALTID" placeholder="Salt">
    <button class="button" type="button" onclick="submitSalt()">Submit Salt</button>
    <br>
    <button type="button" id="ABMELDENID"> Austreten </button>
    <hr>
    <h2>Spieler 3</h2>
    <button class="button" type="button" onclick="joinGame()">Join Game</button>
    <input type="text" id="NUMBERID" placeholder="Number">
    <button class="button" type="button" onclick="submitNumber()">Submit Number</button>
    <input type="text" id="SALTID" placeholder="Salt">
    <button class="button" type="button" onclick="submitSalt()">Submit Salt</button>
    <br>
    <button type="button" id="ABMELDENID"> Austreten </button>
    <hr>
</body>

</html>